<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«è¨‚é¤ç¶²</title>

<style>
:root{--page-width:900px;--bg:#fff4ea}
body{
  background:var(--bg);
  font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;
  color:#333;margin:0;display:flex;
  min-height:100vh;align-items:flex-start;
  justify-content:center;padding:40px 20px
}
.container{
  width:100%;max-width:var(--page-width);
  background:white;border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.07);
  padding:24px;box-sizing:border-box
}
h1{margin:0 0 12px;font-size:20px}
.row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
label{min-width:84px}
/* é‚„åŸåŸæœ¬çš„æ¬„ä½å¯¬åº¦è¨­å®šï¼Œç§»é™¤ width: 100% */
input,select{
  padding:8px;border-radius:6px;border:1px solid #ddd
}
button{
  padding:8px 12px;border-radius:8px;border:0;
  background:#ff8a4b;color:#fff;cursor:pointer
}
button.secondary{background:#ffb777;color:#000}
.center{display:flex;justify-content:center;gap:12px;margin:16px 0}
.menu-area{
  border:1px dashed #ffd3b8;
  padding:12px;border-radius:8px;background:#fff7f0
}
.hidden{display:none}
.order-item{position:relative;padding-right:70px; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px;}
.order-item .delete-btn{
  position:absolute;right:10px;top:50%;
  transform:translateY(-50%);
  background:#ff6b6b;color:#fff;border:0;
  border-radius:6px;padding:6px 10px;cursor:pointer
}
.small{font-size:13px;color:#555;margin-top:4px}
.note{font-size:12px;color:#777}
</style>
</head>
<body>
<div class="container" role="application">
  <h1>å€‰åº«è¨‚é¤ç¶²</h1>

  <div id="page-login">
    <div class="row">
      <label for="empId">å“¡å·¥å·¥è™Ÿ</label>
      <input id="empId" type="text" placeholder="è¼¸å…¥å·¥è™Ÿ (6ç¢¼)" />
    </div>
    <div class="center">
      <button id="btnLogin">ç™»å…¥</button>
    </div>
  </div>

  <div id="page-home" class="hidden">
    <p id="welcome"></p>
    <div class="center">
      <button id="toLunch">ğŸ±åˆé¤</button>
      <button id="toTea" class="secondary">â˜•ä¸‹åˆèŒ¶</button>
    </div>
  </div>

  <div id="page-lunch" class="hidden">
    <div class="row">
      <label for="restaurant">é¤å»³åç¨±</label>
      <select id="restaurant"></select>
    </div>

    <div class="menu-area">
      <div class="row">
        <label>é¤é»é¸æ“‡</label>
        <select id="menuItem"></select>
        <input id="customItem" class="hidden" placeholder="è«‹æ‰‹å‹•è¼¸å…¥é¤é»åç¨±" style="width:250px" />
      </div>

      <div class="row hidden" id="priceRow">
        <label>å–®åƒ¹ (å…ƒ)</label>
        <input id="customPrice" type="number" placeholder="é‡‘é¡" style="width:100px" />
      </div>

      <div class="row hidden" id="additionalRow">
        <label>é†¬æ–™</label>
        <select id="potMain"></select>
      </div>

      <div class="row">
        <label>èª¿å‘³</label>
        <select id="spice">
          <option>ä¸åŠ </option>
          <option>å¾®è¾£</option>
          <option>å°è¾£</option>
          <option>åŠ é†‹</option>
        </select>
      </div>

      <div class="row">
        <label>æ•¸é‡</label>
        <input id="qty" type="number" min="1" value="1" style="width:70px">
      </div>

      <div class="row">
        <label>å‚™è¨»</label>
        <input id="note" placeholder="ä¾‹: å°‘é†¬ã€ä¸è¦è”¥">
      </div>

      <div class="center">
        <button id="addLunch">æ–°å¢è¨‚å–®</button>
        <button id="backFromLunch" class="secondary">å›ä¸Šä¸€é </button>
      </div>
    </div>
  </div>

  <div id="page-tea" class="hidden">
    <div class="row">
      <label for="teaRestaurant">é¤å»³åç¨±</label>
      <select id="teaRestaurant"></select>
    </div>
    <div class="menu-area">
      <div class="row">
        <label>å“é …</label>
        <select id="teaItem"></select>
      </div>
      <div class="row">
        <label>æ•¸é‡</label>
        <input id="teaQty" type="number" min="1" value="1" style="width:70px" />
      </div>
      <div class="row">
        <label>å‚™è¨»</label>
        <input id="teaNote" placeholder="ä¾‹: é†¬å°‘ã€åŠ è¾£...." />
      </div>
      <div class="center">
        <button id="addTea">æ–°å¢ä¸‹åˆèŒ¶è¨‚å–®</button>
        <button id="backFromTea" class="secondary">å›ä¸Šä¸€é </button>
      </div>
    </div>
  </div>

  <div class="orders">
    <h3>æˆ‘çš„è¨‚å–®ï¼ˆå³æ™‚é¡¯ç¤ºï¼‰</h3>
    <div id="ordersList"></div>
    <p class="note">åƒ…é¡¯ç¤ºä½ æœ¬äººçš„è¨‚å–®ï¼Œå¯éš¨æ™‚åˆªé™¤ã€‚</p>
  </div>
</div>

<script>
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyznRRA7TJ28X9TtMU_0r2qhXUemySqgICb6kI-Jd2YA0zzhJxEK6OQr1JOkyL7YtXK/exec";
const MWD_IMAGE_01 = "https://raw.githubusercontent.com/Ameliahidomi/ctcbento/main/MWD01.jpg";
const MWD_IMAGE_02 = "https://raw.githubusercontent.com/Ameliahidomi/ctcbento/main/MWD02.jpg";

let CURRENT_USER = null;
let MENUS = {};
let TEA_DATA = {};

// 39 Pizza é†¬æ–™è¨­å®š
const potMainConfigs = {
  "39 Pizza": ["ç™½é†¬", "ç´…é†¬", "é’é†¬"],
};

const el = id => document.getElementById(id);
const restaurantSel = el("restaurant");
const menuItemSel = el("menuItem");
const customItem = el("customItem");
const customPrice = el("customPrice");
const priceRow = el("priceRow");
const potMainSel = el("potMain");

// é†¬æ–™é¡¯ç¤ºé‚è¼¯
function handlePotMainVisibility() {
  const restaurant = restaurantSel.value; 
  const additionalRow = el("additionalRow");
  let itemObj = {};
  try {
    itemObj = JSON.parse(menuItemSel.value || "{}");
  } catch(e) { itemObj = {}; }
  
  const isTargetRestaurant = restaurant.includes("39 Pizza");
  const catText = (itemObj.cat || "").replace(/\s+/g, "");
  const isTargetCategory = ["æŠ«è–©","ç„—çƒ¤"].some(k => catText.includes(k));

  if (isTargetRestaurant && isTargetCategory) {
    const options = potMainConfigs["39 Pizza"];
    potMainSel.innerHTML = options.map(opt => `<option>${opt}</option>`).join('');
    additionalRow.classList.remove("hidden");
  } else {
    additionalRow.classList.add("hidden");
    potMainSel.innerHTML = "";
  }
}

function openMwdMenu() {
  const menuHtml = `
    <html>
    <head><title>éº¥å‘³ç™»èœå–®</title></head>
    <body style="margin:0; text-align:center; background:#333; color:#fff; font-family:sans-serif;">
      <div style="position:fixed; top:0; width:100%; background:#444; padding:10px; z-index:100;">
        <button style="padding:8px 15px; cursor:pointer;" onclick="document.getElementById('img').src='${MWD_IMAGE_01}'">ç¬¬ä¸€å¼µ</button>
        <button style="padding:8px 15px; cursor:pointer;" onclick="document.getElementById('img').src='${MWD_IMAGE_02}'">ç¬¬äºŒå¼µ</button>
      </div>
      <div style="margin-top:60px;"><img id="img" src="${MWD_IMAGE_01}" style="max-width:100%;"></div>
    </body>
    </html>
  `;
  const win = window.open("", "MwdMenu", "width=1000,height=800");
  win.document.write(menuHtml);
  win.document.close();
}

async function loadMenus() {
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getMenus`);
    MENUS = await res.json();
    restaurantSel.innerHTML = "";
    Object.keys(MENUS).forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      restaurantSel.appendChild(opt);
    });
    if (restaurantSel.options.length > 0) populateMenu(restaurantSel.value);
  } catch (e) { console.error(e); }
}

// æ¢å¾©é¤é»åˆ†é¡é‚è¼¯
function populateMenu(restaurant) {
  if (restaurant.includes("éº¥å‘³ç™»")) {
    openMwdMenu();
    menuItemSel.classList.add("hidden");
    customItem.classList.remove("hidden");
    priceRow.classList.remove("hidden");
    customItem.value = "";
    customPrice.value = "";
  } else {
    menuItemSel.classList.remove("hidden");
    customItem.classList.add("hidden");
    priceRow.classList.add("hidden");
    menuItemSel.innerHTML = "";
    const items = MENUS[restaurant] || [];
    let lastCat = null;
    items.forEach(it => {
      // é‡æ–°åŠ å…¥åˆ†é¡é¡¯ç¤º
      if (it.cat !== lastCat) {
        const catOpt = document.createElement("option");
        catOpt.disabled = true;
        catOpt.textContent = it.cat;
        catOpt.style.fontWeight = "600";
        menuItemSel.appendChild(catOpt);
        lastCat = it.cat;
      }
      const option = document.createElement("option");
      option.value = JSON.stringify(it);
      option.textContent = `${it.name} â€” ${it.price}å…ƒ`;
      menuItemSel.appendChild(option);
    });
  }
  handlePotMainVisibility(); 
}

restaurantSel.addEventListener("change", () => {
  populateMenu(restaurantSel.value);
  el("note").value = "";
  el("spice").selectedIndex = 0;
});

menuItemSel.addEventListener("change", handlePotMainVisibility);

el("btnLogin").addEventListener("click", async () => {
  const empId = el("empId").value.trim();
  const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getEmployees`);
  const employees = await res.json();
  const found = employees.find(e => String(e.id) === empId);
  if (found) {
    CURRENT_USER = found;
    el("page-login").classList.add("hidden");
    el("page-home").classList.remove("hidden");
    el("welcome").textContent = `æ­¡è¿ ${found.name}`;
    loadMenus();
    renderOrders();
  } else { alert("å·¥è™Ÿä¸å­˜åœ¨"); }
});

el("addLunch").addEventListener("click", async () => {
  const date = new Date().toISOString().slice(0, 10);
  const restaurant = restaurantSel.value;
  let itemName, itemPrice, itemCat = "ä¸€èˆ¬";

  if (restaurant.includes("éº¥å‘³ç™»")) {
    itemName = customItem.value.trim();
    itemPrice = customPrice.value.trim();
    itemCat = "è‡ªè¨‚é¤é»";
    if (!itemName || !itemPrice) return alert("è«‹å¡«å¯«é¤é»èˆ‡é‡‘é¡");
  } else {
    const itemObj = JSON.parse(menuItemSel.value || "{}");
    if (!itemObj.name) return alert("è«‹é¸æ“‡é¤é»");
    itemName = itemObj.name;
    itemPrice = itemObj.price;
    itemCat = itemObj.cat || "";
  }

  const params = new URLSearchParams({
    date: date,
    employee: CURRENT_USER.name,
    restaurant: restaurant,
    category: itemCat,
    item: itemName,
    price: itemPrice,
    spice: el("spice").value,
    qty: el("qty").value,
    note: el("note").value,
    potMain: el("potMain").value || ""
  });

  await fetch(GOOGLE_WEBAPP_URL, { method: "POST", body: params });
  alert("è¨‚å–®å·²æ–°å¢");
  renderOrders();
});

async function renderOrders() {
  if (!CURRENT_USER) return;
  const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getOrders&employee=${encodeURIComponent(CURRENT_USER.name)}`);
  const data = await res.json();
  el("ordersList").innerHTML = data.map((o, idx) => `
    <div class="order-item">
      <strong>#${idx + 1} ${o.restaurant} - ${o.item}</strong>
      <div class="small">æ•¸é‡: ${o.qty}ï½œå–®åƒ¹: ${o.price} å…ƒ</div>
      <div class="small">å‚™è¨»: ${o.note || ""}${o.potMain ? "ï½œé†¬æ–™: " + o.potMain : ""}</div>
      <button class="delete-btn" onclick="deleteOrder('${o.id}')">åˆªé™¤</button>
    </div>
  `).join('');
}

window.deleteOrder = async (id) => {
  if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
  const p = new URLSearchParams({ action: "delete", id, employee: CURRENT_USER.name });
  await fetch(GOOGLE_WEBAPP_URL, { method: "POST", body: p });
  renderOrders();
};

el("toLunch").onclick = () => { el("page-home").classList.add("hidden"); el("page-lunch").classList.remove("hidden"); };
el("toTea").onclick = () => { el("page-home").classList.add("hidden"); el("page-tea").classList.remove("hidden"); loadTeaMenus(); };
el("backFromLunch").onclick = () => { el("page-lunch").classList.add("hidden"); el("page-home").classList.remove("hidden"); };
el("backFromTea").onclick = () => { el("page-tea").classList.add("hidden"); el("page-home").classList.remove("hidden"); };
</script>
</body>
</html>