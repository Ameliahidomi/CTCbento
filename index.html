<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«è¨‚é¤ç¶²</title>

<style>
:root{--page-width:900px;--bg:#fff4ea}
body{
  background:var(--bg);
  font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;
  color:#333;margin:0;display:flex;
  min-height:100vh;align-items:flex-start;
  justify-content:center;padding:40px 20px
}
.container{
  width:100%;max-width:var(--page-width);
  background:white;border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.07);
  padding:24px;box-sizing:border-box;position:relative
}
h1{margin:0 0 12px;font-size:20px}
.row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
label{min-width:84px}
input,select{
  padding:8px;border-radius:6px;border:1px solid #ddd
}
button{
  padding:8px 12px;border-radius:8px;border:0;
  background:#ff8a4b;color:#fff;cursor:pointer
}
button.secondary{background:#ffb777;color:#000}
.center{display:flex;justify-content:center;gap:12px;margin:16px 0}
.menu-area{
  border:1px dashed #ffd3b8;
  padding:12px;border-radius:8px;background:#fff7f0
}
.hidden{display:none !important} /* å¼·åˆ¶éš±è—ï¼Œé˜²æ­¢è¼‰å…¥æ™‚é–ƒç¾ */
.order-item{position:relative;padding-right:70px}
.order-item .delete-btn{
  position:absolute;right:10px;top:50%;
  transform:translateY(-50%);
  background:#ff6b6b;color:#fff;border:0;
  border-radius:6px;padding:6px 10px;cursor:pointer
}
.small{font-size:13px;color:#555;margin-top:4px}
.note{font-size:12px;color:#777}

/* æ³¨æ„äº‹é …å½ˆçª—æ¨£å¼ */
#modalOverlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); display: flex; align-items: center;
  justify-content: center; z-index: 10000;
}
.modal-content {
  background: white; padding: 30px; border-radius: 15px;
  max-width: 400px; width: 85%; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  text-align: center;
}
.modal-content h2 { margin-top: 0; color: #ff8a4b; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
.modal-content p { line-height: 1.8; color: #333; margin: 20px 0; font-size: 16px; white-space: pre-wrap; text-align: left; }
.modal-btn { background: #ff8a4b; padding: 10px 40px; font-weight: bold; font-size: 16px; width: 100%; }
</style>
</head>
<body>

<div class="container" role="application">
  <h1>å€‰åº«è¨‚é¤ç¶²</h1>

  <div id="page-login">
    <div class="row">
      <label for="empId">å“¡å·¥å·¥è™Ÿ</label>
      <input id="empId" type="text" placeholder="è¼¸å…¥å·¥è™Ÿ (6ç¢¼)" />
    </div>
    <div class="center">
      <button id="btnLogin">ç™»å…¥</button>
    </div>
  </div>

  <div id="page-home" class="hidden">
    <p id="welcome"></p>
    <div class="center">
      <button id="toLunch">ğŸ±åˆé¤</button>
      <button id="toTea" class="secondary">â˜•ä¸‹åˆèŒ¶</button>
    </div>
  </div>

  <div id="page-lunch" class="hidden">
    <div class="row">
      <label for="restaurant">é¤å»³åç¨±</label>
      <select id="restaurant"></select>
    </div>

    <div class="menu-area">
      <div class="row">
        <label>é¤é»é¸æ“‡</label>
        <select id="menuItem"></select>
      </div>

      <div class="row hidden" id="additionalRow">
        <label id="potMainLabel">å¥—é¤é¸é …</label>
        <select id="potMain"></select>
      </div>

      <div class="row hidden" id="friesRow">
        <label>åŠ è³¼è–¯æ¢</label>
        <select id="addFries">
          <option value="">ä¸åŠ è³¼</option>
          <option value="åŠ è³¼è–¯æ¢-$30">åŠ è³¼è–¯æ¢-$30</option>
        </select>
      </div>

      <div class="row">
        <label>èª¿å‘³</label>
        <select id="spice">
          <option>ä¸åŠ </option>
          <option>å¾®è¾£</option>
          <option>å°è¾£</option>
          <option>ä¸­è¾£</option>
          <option>åŠ é†‹</option>
        </select>
      </div>

      <div class="row">
        <label>æ•¸é‡</label>
        <input id="qty" type="number" min="1" value="1" style="width:70px">
      </div>

      <div class="row">
        <label>å‚™è¨»</label>
        <input id="note" placeholder="ä¾‹: å°‘é†¬ã€ä¸è¦è”¥">
      </div>

      <div class="center">
        <button id="addLunch">æ–°å¢è¨‚å–®</button>
        <button id="backFromLunch" class="secondary">å›ä¸Šä¸€é </button>
      </div>
    </div>
  </div>

  <div id="page-tea" class="hidden">
    <div class="row">
      <label for="teaRestaurant">é¤å»³åç¨±</label>
      <select id="teaRestaurant"></select>
    </div>
    <div class="menu-area">
      <div class="row">
        <label>å“é …</label>
        <select id="teaItem"></select>
      </div>
      <div class="row">
        <label>æ•¸é‡</label>
        <input id="teaQty" type="number" min="1" value="1" style="width:70px" />
      </div>
      <div class="row">
        <label>å‚™è¨»</label>
        <input id="teaNote" placeholder="ä¾‹: é†¬å°‘ã€åŠ è¾£...." />
      </div>
      <div class="center">
        <button id="addTea">æ–°å¢ä¸‹åˆèŒ¶è¨‚å–®</button>
        <button id="backFromTea" class="secondary">å›ä¸Šä¸€é </button>
      </div>
    </div>
  </div>

  <div class="orders">
    <h3>æˆ‘çš„è¨‚å–®ï¼ˆå³æ™‚é¡¯ç¤ºï¼‰</h3>
    <div id="ordersList"></div>
    <p class="note">åƒ…é¡¯ç¤ºä½ æœ¬äººçš„è¨‚å–®ï¼Œå¯éš¨æ™‚åˆªé™¤ã€‚</p>
  </div>
</div>

<div id="modalOverlay" class="hidden">
  <div class="modal-content">
    <h2 id="modalTitle">æ³¨æ„äº‹é …</h2>
    <p id="modalBody"></p>
    <button class="modal-btn" id="btnCloseModal">æˆ‘ç­è§£äº†</button>
  </div>
</div>

<script>
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyznRRA7TJ28X9TtMU_0r2qhXUemySqgICb6kI-Jd2YA0zzhJxEK6OQr1JOkyL7YtXK/exec";
let CURRENT_USER = null;
let MENUS = {};
let TEA_DATA = {};

// æ³¨æ„äº‹é …æ¸…å–®ï¼šåªæœ‰åœ¨æ­¤è™•è¨­å®šçš„é¤å»³æ‰æœƒè·³çª—
const ANNOUNCEMENTS = {
  "è€æå°ç«é‹": "é‹ç‰©åŸºæœ¬å…§å®¹ç‰©ç‚ºï¼šè±†çš®ã€é«˜éº—èœã€é³¥è›‹ã€é‡‘é‡è‡ã€è±†èŠ½èœã€è‚‰ç‰‡ã€ç«é‹æ–™ã€‚"
};

const potMainConfigs = {
  "è€æ±Ÿç´…èŒ¶": [{
    categoryKey: "å¥—é¤çµ„åˆ",
    options: ["ç´…èŒ¶å†°-$81", "å†·æ³¡èŒ¶-$81", "å°æ¯å¥¶èŒ¶-$89", "ä¸­æ¯å¥¶èŒ¶-$106"],
    label: "å¥—é¤é£²æ–™"
  }],
  "è€æå°ç«é‹": [{
    categoryKey: "é‹ç‰©æ¹¯åº•", 
    options: ["ç™½é£¯", "æ„éºµ", "ç§‘å­¸éºµ", "å†¬ç²‰", "è’¸ç…®éºµ", "ç‹å­éºµ"],
    label: "ä¸»é£Ÿé¸æ“‡"
  }]
};

const el = id => document.getElementById(id);

// å½ˆçª—æ§åˆ¶
function showNotice(fullRestaurantName) {
  // éæ­·æ‰€æœ‰æ³¨æ„äº‹é …çš„é—œéµå­—
  for (let key in ANNOUNCEMENTS) {
    if (fullRestaurantName.includes(key)) {
      el("modalTitle").textContent = `${key} æ³¨æ„äº‹é …`;
      el("modalBody").textContent = ANNOUNCEMENTS[key];
      el("modalOverlay").classList.remove("hidden");
      break; // åŒ¹é…åˆ°ç¬¬ä¸€å€‹å°±è·³å‡º
    }
  }
}
el("btnCloseModal").onclick = () => el("modalOverlay").classList.add("hidden");

// å¥—é¤é¸é …é¡¯ç¤ºé‚è¼¯
function handlePotMainVisibility() {
  const restaurant = el("restaurant").value;
  const additionalRow = el("additionalRow");
  const friesRow = el("friesRow");
  const labelEl = el("potMainLabel");
  
  let itemObj = {};
  try { itemObj = JSON.parse(el("menuItem").value || "{}"); } catch(e) { itemObj = {}; }

  const configs = potMainConfigs[Object.keys(potMainConfigs).find(k => restaurant.includes(k))];
  
  if (configs && itemObj.cat) {
    const cleanCat = itemObj.cat.replace(/\s+/g, '');
    const foundConfig = configs.find(c => cleanCat.includes(c.categoryKey.replace(/\s+/g, '')));

    if (foundConfig) {
      labelEl.textContent = foundConfig.label;
      el("potMain").innerHTML = foundConfig.options.map(opt => `<option>${opt}</option>`).join('');
      additionalRow.classList.remove("hidden");

      // è€æ±Ÿå¥—é¤å°ˆå±¬ï¼šé¡¯ç¤ºè–¯æ¢åŠ è³¼
      if (restaurant.includes("è€æ±Ÿç´…èŒ¶") && cleanCat.includes("å¥—é¤çµ„åˆ")) {
        friesRow.classList.remove("hidden");
      } else {
        friesRow.classList.add("hidden");
        el("addFries").selectedIndex = 0;
      }
      return;
    }
  }
  additionalRow.classList.add("hidden");
  friesRow.classList.add("hidden");
  el("addFries").selectedIndex = 0;
}

// é¤å»³åˆ‡æ›åµæ¸¬
el("restaurant").addEventListener("change", (e) => {
  const selectedVal = e.target.value;
  
  // æ¼¢å ¡ç‹è™•ç†
  if (selectedVal.includes("æ¼¢å ¡ç‹")) {
    window.open("https://forms.gle/zrCN8DFXG1zqW3TC8", "_blank");
    el("restaurant").selectedIndex = 0;
    populateMenu(el("restaurant").value);
    return;
  }

  // è§¸ç™¼æ³¨æ„äº‹é …ï¼ˆå¦‚æœæœ‰è¨­å®šï¼‰
  showNotice(selectedVal);

  populateMenu(selectedVal);
  el("qty").value = 1;
  el("note").value = "";
  el("spice").selectedIndex = 0;
});

// ç™»å…¥é‚è¼¯
el("btnLogin").addEventListener("click", async () => {
  const empId = el("empId").value.trim();
  if (!empId) return alert("è«‹è¼¸å…¥å·¥è™Ÿ");
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getEmployees`);
    const employees = await res.json();
    const found = employees.find(e => String(e.id) === empId);
    if (found) {
      CURRENT_USER = found;
      el("page-login").classList.add("hidden");
      el("page-home").classList.remove("hidden");
      el("welcome").textContent = `æ­¡è¿ ${found.name}`;
      loadMenus();
      renderOrders();
    } else { alert("å·¥è™Ÿä¸å­˜åœ¨"); }
  } catch (e) { alert("ç³»çµ±é€£ç·šå¤±æ•—"); }
});

// è¼‰å…¥èˆ‡å¡«å……é¸å–®
async function loadMenus() {
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getMenus`);
    MENUS = await res.json();
    const restSel = el("restaurant");
    restSel.innerHTML = Object.keys(MENUS).map(r => `<option value="${r}">${r}</option>`).join('');
    if (restSel.options.length > 0) populateMenu(restSel.value);
  } catch (e) { console.error(e); }
}

function populateMenu(restaurant) {
  const menuSel = el("menuItem");
  menuSel.innerHTML = "";
  const items = MENUS[restaurant] || [];
  let lastCat = null;
  items.forEach(it => {
    if (it.cat !== lastCat) {
      const catOpt = document.createElement("option");
      catOpt.disabled = true; catOpt.textContent = `[ ${it.cat} ]`;
      menuSel.appendChild(catOpt);
      lastCat = it.cat;
    }
    const option = document.createElement("option");
    option.value = JSON.stringify(it);
    option.textContent = `${it.name} â€” ${it.price}å…ƒ`;
    menuSel.appendChild(option);
  });
  handlePotMainVisibility(); 
}

el("menuItem").onchange = () => { el("qty").value = 1; handlePotMainVisibility(); };

// æ–°å¢è¨‚å–®
el("addLunch").onclick = async () => {
  const itemObj = JSON.parse(el("menuItem").value || "{}");
  if (!itemObj.name) return alert("è«‹é¸æ“‡é¤é»");
  let finalNote = el("note").value;
  if (el("addFries").value && !el("friesRow").classList.contains("hidden")) {
    finalNote = finalNote ? `${finalNote} / ${el("addFries").value}` : el("addFries").value;
  }
  const params = new URLSearchParams({
    date: new Date().toISOString().slice(0, 10),
    employee: CURRENT_USER.name,
    restaurant: el("restaurant").value,
    category: itemObj.cat || "",
    item: itemObj.name,
    price: itemObj.price ?? "",
    spice: el("spice").value,
    qty: el("qty").value,
    note: finalNote,
    potMain: el("potMain").value || ""
  });
  await fetch(GOOGLE_WEBAPP_URL, { method: "POST", body: params });
  alert("è¨‚å–®å·²æ–°å¢");
  renderOrders();
};

async function renderOrders() {
  if (!CURRENT_USER) return;
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getOrders&employee=${encodeURIComponent(CURRENT_USER.name)}`);
    const data = await res.json();
    el("ordersList").innerHTML = data.map((o, i) => `
      <div class="order-item">
        <strong>#${i+1} ${o.restaurant} - ${o.item}</strong>
        <div class="small">æ•¸é‡: ${o.qty}ï½œåƒ¹æ ¼: ${o.price}ï½œèª¿å‘³: ${o.spice || ""}</div>
        <div class="small">å‚™è¨»: ${o.note || ""}${o.potMain ? "ï½œé¸é …: " + o.potMain : ""}</div>
        <button class="delete-btn" data-id="${o.id}">åˆªé™¤</button>
      </div>`).join('');
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.onclick = async () => {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        const p = new URLSearchParams({ action: "delete", id: btn.dataset.id, employee: CURRENT_USER.name });
        await fetch(GOOGLE_WEBAPP_URL, { method: "POST", body: p });
        renderOrders();
      };
    });
  } catch (e) { console.error(e); }
}

// é é¢åˆ‡æ›
el("toLunch").onclick = () => { el("page-home").classList.add("hidden"); el("page-lunch").classList.remove("hidden"); };
el("toTea").onclick = () => { el("page-home").classList.add("hidden"); el("page-tea").classList.remove("hidden"); loadTeaMenus(); };
el("backFromLunch").onclick = () => { el("page-lunch").classList.add("hidden"); el("page-home").classList.remove("hidden"); };
el("backFromTea").onclick = () => { el("page-tea").classList.add("hidden"); el("page-home").classList.remove("hidden"); };
</script>
</body>
</html>