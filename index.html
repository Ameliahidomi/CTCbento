<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«è¨‚é¤ç¶²</title>

<style>
:root{--page-width:900px;--bg:#fff4ea}
body{
  background:var(--bg);
  font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;
  color:#333;margin:0;display:flex;
  min-height:100vh;align-items:flex-start;
  justify-content:center;padding:40px 20px
}
.container{
  width:100%;max-width:var(--page-width);
  background:white;border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.07);
  padding:24px;box-sizing:border-box
}
h1{margin:0 0 12px;font-size:20px}
.row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
label{min-width:84px}
input,select{
  padding:8px;border-radius:6px;border:1px solid #ddd
}
button{
  padding:8px 12px;border-radius:8px;border:0;
  background:#ff8a4b;color:#fff;cursor:pointer
}
button.secondary{background:#ffb777;color:#000}
.center{display:flex;justify-content:center;gap:12px;margin:16px 0}
.menu-area{
  border:1px dashed #ffd3b8;
  padding:12px;border-radius:8px;background:#fff7f0
}
.hidden{display:none}
.order-item{position:relative;padding-right:70px}
.order-item .delete-btn{
  position:absolute;right:10px;top:50%;
  transform:translateY(-50%);
  background:#ff6b6b;color:#fff;border:0;
  border-radius:6px;padding:6px 10px;cursor:pointer
}
.small{font-size:13px;color:#555;margin-top:4px}
.note{font-size:12px;color:#777}
</style>
</head>
<body>
<div class="container" role="application">
  <h1>å€‰åº«è¨‚é¤ç¶²</h1>

  <div id="page-login">
    <div class="row">
      <label for="empId">å“¡å·¥å·¥è™Ÿ</label>
      <input id="empId" type="text" placeholder="è¼¸å…¥å·¥è™Ÿ (6ç¢¼)" />
    </div>
    <div class="center">
      <button id="btnLogin">ç™»å…¥</button>
    </div>
  </div>

  <div id="page-home" class="hidden">
    <p id="welcome"></p>
    <div class="center">
      <button id="toLunch">ğŸ±åˆé¤</button>
      <button id="toTea" class="secondary">â˜•ä¸‹åˆèŒ¶</button>
    </div>
  </div>

  <div id="page-lunch" class="hidden">
    <div class="row">
      <label for="restaurant">é¤å»³åç¨±</label>
      <select id="restaurant"></select>
    </div>

    <div class="menu-area">
      <div class="row">
        <label>é¤é»é¸æ“‡</label>
        <select id="menuItem"></select>
      </div>

    <div class="row hidden" id="additionalRow">
      <label id="potMainLabel">å¥—é¤é¸é …</label>
      <select id="potMain"></select>
    </div>

    <div class="row hidden" id="friesRow">
      <label>åŠ è³¼è–¯æ¢</label>
      <select id="addFries">
        <option value="">ä¸åŠ è³¼</option>
        <option value="åŠ è³¼è–¯æ¢-$30">åŠ è³¼è–¯æ¢-$30</option>
      </select>
    </div>

    <div class="row">
      <label>èª¿å‘³</label>
      <select id="spice">
        <option>ä¸åŠ </option>
        <option>å¾®è¾£</option>
        <option>å°è¾£</option>
        <option>ä¸­è¾£</option>
        <option>åŠ é†‹</option>
      </select>
    </div>

    <div class="row">
      <label>æ•¸é‡</label>
      <input id="qty" type="number" min="1" value="1" style="width:70px">
    </div>

    <div class="row">
      <label>å‚™è¨»</label>
      <input id="note" placeholder="ä¾‹: å°‘é†¬ã€ä¸è¦è”¥">
    </div>

    <div class="center">
      <button id="addLunch">æ–°å¢è¨‚å–®</button>
      <button id="backFromLunch" class="secondary">å›ä¸Šä¸€é </button>
    </div>
  </div>
</div>

  <div id="page-tea" class="hidden">
    <div class="row">
      <label for="teaRestaurant">é¤å»³åç¨±</label>
      <select id="teaRestaurant"></select>
    </div>

    <div class="menu-area">
      <div class="row">
        <label>å“é …</label>
        <select id="teaItem"></select>
      </div>

      <div class="row">
        <label>æ•¸é‡</label>
        <input id="teaQty" type="number" min="1" value="1" style="width:70px" />
      </div>

      <div class="row">
        <label>å‚™è¨»</label>
        <input id="teaNote" placeholder="ä¾‹: é†¬å°‘ã€åŠ è¾£...." />
      </div>

      <div class="center">
        <button id="addTea">æ–°å¢ä¸‹åˆèŒ¶è¨‚å–®ï¼ˆé€å‡ºåˆ°åœ˜ä¸»ï¼‰</button>
        <button id="backFromTea" class="secondary">å›ä¸Šä¸€é </button>
      </div>
    </div>
  </div>

  <div class="orders">
    <h3>æˆ‘çš„è¨‚å–®ï¼ˆå³æ™‚é¡¯ç¤ºï¼‰</h3>
    <div id="ordersList"></div>
    <p class="note">åƒ…é¡¯ç¤ºä½ æœ¬äººçš„è¨‚å–®ï¼Œå¯éš¨æ™‚åˆªé™¤ã€‚</p>
  </div>
</div>

<script>
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyznRRA7TJ28X9TtMU_0r2qhXUemySqgICb6kI-Jd2YA0zzhJxEK6OQr1JOkyL7YtXK/exec";
let CURRENT_USER = null;
let MENUS = {};
let TEA_DATA = {};

const potMainConfigs = {
  "è€æ±Ÿç´…èŒ¶": [
    {
      categoryKey: "å¥—é¤çµ„åˆ",
      options: ["ç´…èŒ¶å†°-$81", "å†·æ³¡èŒ¶-$81", "å°æ¯å¥¶èŒ¶-$89", "ä¸­æ¯å¥¶èŒ¶-$106"],
      label: "å¥—é¤é£²æ–™"
    }
  ],
  "è€æå°ç«é‹": [
    {
      categoryKey: "é‹ç‰©æ¹¯åº•", 
      options: ["ç™½é£¯", "æ„éºµ", "ç§‘å­¸éºµ", "å†¬ç²‰", "è’¸ç…®éºµ", "ç‹å­éºµ"],
      label: "ä¸»é£Ÿé¸æ“‡"
    }
  ]
};

const el = id => document.getElementById(id);
const restaurantSel = el("restaurant");
const menuItemSel = el("menuItem");
const potMainSel = el("potMain");
const teaRestaurantSel = el("teaRestaurant");
const teaItemSel = el("teaItem");

function resetQty() {
  el("qty").value = 1;
}

function handlePotMainVisibility() {
  const restaurant = el("restaurant").value;
  const additionalRow = el("additionalRow");
  const friesRow = el("friesRow");
  const labelEl = el("potMainLabel");
  const potMainSel = el("potMain"); // å–å¾—é¸é …ä¸‹æ‹‰é¸å–®
  
  let itemObj = {};
  try { itemObj = JSON.parse(el("menuItem").value || "{}"); } catch(e) { itemObj = {}; }

  const configs = potMainConfigs[Object.keys(potMainConfigs).find(k => restaurant.includes(k))];
  
  if (configs && itemObj.cat) {
    const cleanCat = itemObj.cat.replace(/\s+/g, '');
    const foundConfig = configs.find(c => cleanCat.includes(c.categoryKey.replace(/\s+/g, '')));

    if (foundConfig) {
      labelEl.textContent = foundConfig.label;
      potMainSel.innerHTML = foundConfig.options.map(opt => `<option>${opt}</option>`).join('');
      additionalRow.classList.remove("hidden");

      if (restaurant.includes("è€æ±Ÿç´…èŒ¶") && cleanCat.includes("å¥—é¤çµ„åˆ")) {
        friesRow.classList.remove("hidden");
      } else {
        friesRow.classList.add("hidden");
        el("addFries").selectedIndex = 0;
      }
      return;
    }
  }

  // --- é‡é»ä¿®æ­£å€ï¼šç•¶ä¸ç¬¦åˆå¥—é¤æ¢ä»¶æ™‚ï¼Œå‹™å¿…æ¸…ç©ºå…§å®¹èˆ‡éš±è— ---
  additionalRow.classList.add("hidden");
  friesRow.classList.add("hidden");
  el("addFries").selectedIndex = 0;
  potMainSel.innerHTML = ""; // å¾¹åº•æ¸…ç©º HTML å…§å®¹ï¼Œé¿å…æ®˜ç•™èˆŠè³‡æ–™
}

async function loadMenus() {
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getMenus`);
    MENUS = await res.json();
  } catch (e) {
    console.error("fetch menus failed", e);
    MENUS = {};
  }

  restaurantSel.innerHTML = "";
  Object.keys(MENUS).forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    restaurantSel.appendChild(opt);
  });

  if (restaurantSel.options.length > 0) {
    restaurantSel.selectedIndex = 0;
    populateMenu(restaurantSel.value);
  }
}

function populateMenu(restaurant) {
  menuItemSel.innerHTML = "";
  const items = MENUS[restaurant] || [];
  let lastCat = null;

  items.forEach(it => {
    if (it.cat !== lastCat) {
      const catOpt = document.createElement("option");
      catOpt.disabled = true;
      catOpt.textContent = it.cat;
      catOpt.style.fontWeight = "600";
      menuItemSel.appendChild(catOpt);
      lastCat = it.cat;
    }
    const option = document.createElement("option");
    option.value = JSON.stringify(it);
    option.textContent = `${it.name} â€” ${it.price}å…ƒ`;
    menuItemSel.appendChild(option);
  });

  handlePotMainVisibility(); 
}

restaurantSel.addEventListener("change", () => {
  const selectedVal = restaurantSel.value;
  if (selectedVal.includes("æ¼¢å ¡ç‹")) {
    window.open("https://forms.gle/zrCN8DFXG1zqW3TC8", "_blank");
    if (restaurantSel.options.length > 0) {
      restaurantSel.selectedIndex = 0;
      populateMenu(restaurantSel.value);
    }
    return;
  }
  resetQty();
  populateMenu(selectedVal);
  el("note").value = "";
  el("spice").selectedIndex = 0;
});

menuItemSel.addEventListener("change", () => {
  resetQty();
  handlePotMainVisibility();
});

async function loadTeaMenus() {
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getTeaMenus`);
    TEA_DATA = await res.json();
    teaRestaurantSel.innerHTML = "";
    Object.keys(TEA_DATA).forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      teaRestaurantSel.appendChild(opt);
    });
    if (teaRestaurantSel.options.length > 0) {
      teaRestaurantSel.selectedIndex = 0;
      populateTeaMenu(teaRestaurantSel.value);
    }
  } catch (e) { console.error(e); }
}

function populateTeaMenu(restaurant) {
  teaItemSel.innerHTML = "";
  const items = TEA_DATA[restaurant] || [];
  let lastCat = null;
  items.forEach(it => {
    if (it.cat !== lastCat) {
      const catOpt = document.createElement("option");
      catOpt.disabled = true;
      catOpt.textContent = it.cat;
      catOpt.style.fontWeight = "600";
      teaItemSel.appendChild(catOpt);
      lastCat = it.cat;
    }
    const option = document.createElement("option");
    option.value = JSON.stringify(it);
    option.textContent = `${it.name} â€” ${it.price}å…ƒ`;
    teaItemSel.appendChild(option);
  });
}

teaRestaurantSel.addEventListener("change", () => {
  populateTeaMenu(teaRestaurantSel.value);
});

el("btnLogin").addEventListener("click", async () => {
  const empId = el("empId").value.trim();
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getEmployees`);
    const employees = await res.json();
    const found = employees.find(e => String(e.id) === empId);
    if (found) {
      CURRENT_USER = found;
      el("page-login").classList.add("hidden");
      el("page-home").classList.remove("hidden");
      el("welcome").textContent = `æ­¡è¿ ${found.name}`;
      loadMenus();
      renderOrders();
    } else { alert("å·¥è™Ÿä¸å­˜åœ¨"); }
  } catch (e) { alert("ç™»å…¥å¤±æ•—"); }
});

el("addLunch").addEventListener("click", async () => {
  const date = new Date().toISOString().slice(0, 10);
  const restaurant = restaurantSel.value;
  const itemObj = JSON.parse(menuItemSel.value || "{}");
  if (!itemObj.name) return alert("è«‹é¸æ“‡é¤é»");

  // çµ„åˆå‚™è¨»
  let finalNote = el("note").value;
  const friesVal = el("addFries").value;
  if (friesVal && !el("friesRow").classList.contains("hidden")) {
    finalNote = finalNote ? `${finalNote} / ${friesVal}` : friesVal;
  }

  const params = new URLSearchParams();
  params.append("date", date);
  params.append("employee", CURRENT_USER.name);
  params.append("restaurant", restaurant);
  params.append("category", itemObj.cat || "");
  params.append("item", itemObj.name);
  params.append("price", itemObj.price ?? "");
  params.append("spice", el("spice").value);
  params.append("qty", el("qty").value);
  params.append("note", finalNote);
  params.append("potMain", el("potMain").value || "");

  try {
    await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
    });
    alert("è¨‚å–®å·²æ–°å¢");
    renderOrders();
  } catch (e) { alert("æ–°å¢å¤±æ•—"); }
});

async function renderOrders() {
  const ordersList = el("ordersList");
  if (!CURRENT_USER) return;
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getOrders&employee=${encodeURIComponent(CURRENT_USER.name)}`);
    const data = await res.json();
    ordersList.innerHTML = "";
    data.forEach((o, idx) => {
      const div = document.createElement("div");
      div.className = "order-item";
      div.innerHTML = `
        <strong>#${idx + 1} ${o.restaurant} - ${o.item}</strong>
        <div class="small">æ•¸é‡: ${o.qty}ï½œåƒ¹æ ¼: ${o.price}ï½œèª¿å‘³: ${o.spice || ""}</div>
        <div class="small">å‚™è¨»: ${o.note || ""}${o.potMain ? "ï½œé¸é …: " + o.potMain : ""}</div>
        <button class="delete-btn" data-id="${o.id}">åˆªé™¤</button>
      `;
      ordersList.appendChild(div);
    });
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const params = new URLSearchParams();
        params.append("action", "delete");
        params.append("id", btn.dataset.id);
        params.append("employee", CURRENT_USER.name);
        await fetch(GOOGLE_WEBAPP_URL, { method: "POST", body: params });
        renderOrders();
      });
    });
  } catch (e) { console.error(e); }
}

el("toLunch").addEventListener("click", () => {
  el("page-home").classList.add("hidden");
  el("page-lunch").classList.remove("hidden");
});
el("toTea").addEventListener("click", () => {
  el("page-home").classList.add("hidden");
  el("page-tea").classList.remove("hidden");
  loadTeaMenus();
});
el("backFromLunch").addEventListener("click", () => {
  el("page-lunch").classList.add("hidden");
  el("page-home").classList.remove("hidden");
});
el("backFromTea").addEventListener("click", () => {
  el("page-tea").classList.add("hidden");
  el("page-home").classList.remove("hidden");
});
</script>
</body>
</html>